"""
CACHE Y√ñNETƒ∞M Sƒ∞STEMƒ∞
SQLite tabanlƒ± hƒ±zlƒ± cache - API √ßaƒürƒ±larƒ±nƒ± azaltƒ±r
"""
import sqlite3
import json
import time
from datetime import datetime, timedelta
from typing import Optional, Any, Dict
import hashlib
import os

class CacheManager:
    """
    Akƒ±llƒ± cache sistemi - API yanƒ±tlarƒ±nƒ± √∂nbelleƒüe alƒ±r
    """
    
    def __init__(self, db_path: str = "api_cache.db"):
        """Cache veritabanƒ±nƒ± ba≈ülat"""
        self.db_path = db_path
        self._init_database()
    
    def _init_database(self):
        """Veritabanƒ± tablolarƒ±nƒ± olu≈ütur"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Cache tablosu
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS cache (
                cache_key TEXT PRIMARY KEY,
                data TEXT NOT NULL,
                category TEXT NOT NULL,
                created_at REAL NOT NULL,
                expires_at REAL NOT NULL,
                hit_count INTEGER DEFAULT 0
            )
        """)
        
        # ƒ∞statistik tablosu
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS cache_stats (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                date TEXT NOT NULL,
                cache_hits INTEGER DEFAULT 0,
                cache_misses INTEGER DEFAULT 0,
                api_calls_saved INTEGER DEFAULT 0
            )
        """)
        
        conn.commit()
        conn.close()
        
        print(f"‚úÖ Cache veritabanƒ± hazƒ±r: {self.db_path}")
    
    def _generate_key(self, category: str, **kwargs) -> str:
        """Cache anahtarƒ± olu≈ütur"""
        # Parametreleri sƒ±ralƒ± string'e √ßevir
        params = json.dumps(kwargs, sort_keys=True)
        # Hash ile kƒ±sa anahtar olu≈ütur
        hash_obj = hashlib.md5(f"{category}:{params}".encode())
        return hash_obj.hexdigest()
    
    def get(self, category: str, **kwargs) -> Optional[Any]:
        """
        Cache'den veri al
        
        Args:
            category: Veri kategorisi (team_data, transfers, xg, etc.)
            **kwargs: Anahtar parametreleri (team_id, season, etc.)
        
        Returns:
            Cache'deki veri veya None
        """
        cache_key = self._generate_key(category, **kwargs)
        
        conn = sqlite3.connect(self.db_path, timeout=10)
        cursor = conn.cursor()
        
        # Cache'i kontrol et
        cursor.execute("""
            SELECT data, expires_at, hit_count 
            FROM cache 
            WHERE cache_key = ? AND expires_at > ?
        """, (cache_key, time.time()))
        
        result = cursor.fetchone()
        
        if result:
            data_json, expires_at, hit_count = result
            
            # Hit count g√ºncelle
            cursor.execute("""
                UPDATE cache 
                SET hit_count = hit_count + 1 
                WHERE cache_key = ?
            """, (cache_key,))
            
            # ƒ∞statistik g√ºncelle (aynƒ± connection kullan)
            self._update_stats('hit', conn)
            
            conn.commit()
            conn.close()
            
            # JSON'dan objeye √ßevir
            data = json.loads(data_json)
            
            # Kalan s√ºreyi hesapla
            remaining = int(expires_at - time.time())
            print(f"üéØ Cache HIT [{category}] - Kalan s√ºre: {remaining}s")
            
            return data
        else:
            # Cache miss
            conn.close()
            self._update_stats('miss')
            print(f"‚ùå Cache MISS [{category}] - API √ßaƒürƒ±sƒ± yapƒ±lacak")
            return None
    
    def set(self, category: str, data: Any, ttl_seconds: int = 1800, **kwargs):
        """
        Cache'e veri kaydet
        
        Args:
            category: Veri kategorisi
            data: Kaydedilecek veri
            ttl_seconds: Ya≈üam s√ºresi (saniye)
            **kwargs: Anahtar parametreleri
        """
        cache_key = self._generate_key(category, **kwargs)
        data_json = json.dumps(data)
        
        now = time.time()
        expires_at = now + ttl_seconds
        
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Cache'e kaydet (var ise √ºzerine yaz)
        cursor.execute("""
            INSERT OR REPLACE INTO cache 
            (cache_key, data, category, created_at, expires_at, hit_count)
            VALUES (?, ?, ?, ?, ?, 0)
        """, (cache_key, data_json, category, now, expires_at))
        
        conn.commit()
        conn.close()
        
        print(f"üíæ Cache SAVE [{category}] - TTL: {ttl_seconds}s")
    
    def _update_stats(self, stat_type: str, conn=None):
        """ƒ∞statistikleri g√ºncelle"""
        today = datetime.now().strftime('%Y-%m-%d')
        
        # Eƒüer connection verilmediyse yeni olu≈ütur
        own_conn = False
        if conn is None:
            conn = sqlite3.connect(self.db_path, timeout=10)
            own_conn = True
        
        cursor = conn.cursor()
        
        # Bug√ºn√ºn kaydƒ±nƒ± bul veya olu≈ütur
        cursor.execute("""
            INSERT OR IGNORE INTO cache_stats (date) VALUES (?)
        """, (today,))
        
        # ƒ∞statistiƒüi g√ºncelle
        if stat_type == 'hit':
            cursor.execute("""
                UPDATE cache_stats 
                SET cache_hits = cache_hits + 1,
                    api_calls_saved = api_calls_saved + 1
                WHERE date = ?
            """, (today,))
        else:  # miss
            cursor.execute("""
                UPDATE cache_stats 
                SET cache_misses = cache_misses + 1
                WHERE date = ?
            """, (today,))
        
        conn.commit()
        
        # Sadece kendi a√ßtƒ±ƒüƒ±mƒ±z connection'ƒ± kapat
        if own_conn:
            conn.close()
    
    def clear_expired(self):
        """S√ºresi dolmu≈ü cache'leri temizle"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            DELETE FROM cache WHERE expires_at < ?
        """, (time.time(),))
        
        deleted = cursor.rowcount
        conn.commit()
        conn.close()
        
        if deleted > 0:
            print(f"üßπ {deleted} s√ºresi dolmu≈ü cache silindi")
        
        return deleted
    
    def clear_category(self, category: str):
        """Belirli bir kategorideki t√ºm cache'leri temizle"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("DELETE FROM cache WHERE category = ?", (category,))
        
        deleted = cursor.rowcount
        conn.commit()
        conn.close()
        
        print(f"üßπ {category} kategorisinden {deleted} cache silindi")
        return deleted
    
    def clear_all(self):
        """T√ºm cache'i temizle"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("DELETE FROM cache")
        
        deleted = cursor.rowcount
        conn.commit()
        conn.close()
        
        print(f"üßπ Toplam {deleted} cache silindi")
        return deleted
    
    def get_stats(self) -> Dict:
        """Cache istatistiklerini getir"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Bug√ºn√ºn istatistikleri
        today = datetime.now().strftime('%Y-%m-%d')
        cursor.execute("""
            SELECT cache_hits, cache_misses, api_calls_saved
            FROM cache_stats
            WHERE date = ?
        """, (today,))
        
        today_stats = cursor.fetchone()
        
        # Toplam cache sayƒ±sƒ±
        cursor.execute("SELECT COUNT(*) FROM cache WHERE expires_at > ?", (time.time(),))
        total_active = cursor.fetchone()[0]
        
        # Kategori ba≈üƒ±na daƒüƒ±lƒ±m
        cursor.execute("""
            SELECT category, COUNT(*) 
            FROM cache 
            WHERE expires_at > ?
            GROUP BY category
        """, (time.time(),))
        
        by_category = dict(cursor.fetchall())
        
        conn.close()
        
        if today_stats:
            hits, misses, saved = today_stats
            total = hits + misses
            hit_rate = (hits / total * 100) if total > 0 else 0
        else:
            hits = misses = saved = 0
            hit_rate = 0
        
        return {
            'today': {
                'hits': hits,
                'misses': misses,
                'total': hits + misses,
                'hit_rate': round(hit_rate, 1),
                'api_calls_saved': saved
            },
            'cache': {
                'total_active': total_active,
                'by_category': by_category
            }
        }
    
    def print_stats(self):
        """ƒ∞statistikleri g√ºzel formatta yazdƒ±r"""
        stats = self.get_stats()
        
        print("\n" + "="*60)
        print("üìä CACHE ƒ∞STATƒ∞STƒ∞KLERƒ∞")
        print("="*60)
        
        print(f"\nüìÖ BUG√úN:")
        print(f"  ‚úÖ Cache Hit: {stats['today']['hits']}")
        print(f"  ‚ùå Cache Miss: {stats['today']['misses']}")
        print(f"  üìà Hit Rate: %{stats['today']['hit_rate']}")
        print(f"  üí∞ API Tasarrufu: {stats['today']['api_calls_saved']} √ßaƒürƒ±")
        
        print(f"\nüíæ AKTƒ∞F CACHE:")
        print(f"  üì¶ Toplam: {stats['cache']['total_active']} kayƒ±t")
        
        if stats['cache']['by_category']:
            print(f"\n  üìÇ Kategoriler:")
            for category, count in stats['cache']['by_category'].items():
                print(f"    ‚Ä¢ {category}: {count} kayƒ±t")
        
        print("\n" + "="*60)


# Singleton instance
_cache_instance = None

def get_cache() -> CacheManager:
    """Global cache instance'ƒ± getir"""
    global _cache_instance
    if _cache_instance is None:
        _cache_instance = CacheManager()
    return _cache_instance


# Decorator fonksiyonu - kolay kullanƒ±m i√ßin
def cached(category: str, ttl: int = 1800):
    """
    Cache decorator - fonksiyon sonu√ßlarƒ±nƒ± cache'ler
    
    Kullanƒ±m:
    @cached('team_data', ttl=1800)
    def get_team_info(team_id):
        # API √ßaƒürƒ±sƒ±
        return data
    """
    def decorator(func):
        def wrapper(*args, **kwargs):
            cache = get_cache()
            
            # Cache anahtarƒ± i√ßin parametreleri kullan
            cache_params = {
                'func': func.__name__,
                'args': str(args),
                **kwargs
            }
            
            # √ñnce cache'e bak
            cached_data = cache.get(category, **cache_params)
            if cached_data is not None:
                return cached_data
            
            # Cache miss - fonksiyonu √ßalƒ±≈ütƒ±r
            result = func(*args, **kwargs)
            
            # Sonucu cache'e kaydet
            if result is not None:
                cache.set(category, result, ttl, **cache_params)
            
            return result
        
        return wrapper
    return decorator


# Test fonksiyonu
if __name__ == "__main__":
    print("üß™ CACHE Sƒ∞STEMƒ∞ TEST")
    print("="*60)
    
    # Cache instance olu≈ütur
    cache = CacheManager()
    
    # Test verisi
    test_data = {
        'team_id': 645,
        'name': 'Galatasaray',
        'elo': 1850,
        'value': 285.3
    }
    
    # 1. Veriyi kaydet
    print("\n1. Cache'e kaydet:")
    cache.set('team_data', test_data, ttl_seconds=30, team_id=645)
    
    # 2. Veriyi oku (hit olmalƒ±)
    print("\n2. Cache'den oku (HIT bekleniyor):")
    result = cache.get('team_data', team_id=645)
    print(f"   Sonu√ß: {result}")
    
    # 3. Tekrar oku (yine hit)
    print("\n3. Tekrar oku (HIT bekleniyor):")
    result = cache.get('team_data', team_id=645)
    print(f"   Sonu√ß: {result}")
    
    # 4. Farklƒ± key (miss olmalƒ±)
    print("\n4. Farklƒ± team_id (MISS bekleniyor):")
    result = cache.get('team_data', team_id=999)
    print(f"   Sonu√ß: {result}")
    
    # 5. ƒ∞statistikler
    print("\n5. ƒ∞statistikler:")
    cache.print_stats()
    
    # 6. Temizlik testi
    print("\n6. Cache temizliƒüi:")
    print(f"   S√ºresi dolmu≈ü: {cache.clear_expired()}")
    print(f"   Toplam silme: {cache.clear_category('team_data')}")
    
    print("\n‚úÖ Test tamamlandƒ±!")
